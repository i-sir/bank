<!--客户类型:1农户,2牧户,3个体工商户,4公职人员,5政府全资或控股企业正式职工,6社区居民,7民营小微企业,8合作经济组织,9政府全资或控股企业,10行政事业单位,11其他群体-->
<div class="form-group">
    <label class="col-sm-2 control-label">客户类型:</label>
    <div class="layui-input-block col-sm-6">
        <if condition="!empty($type)">
            <select class="form-control post-params" lay-search lay-filter="type" name="type">
                <foreach item="vo" key="key" name="type_list">
                    <option value="{$key}"
                    <if condition="$type eq $key ">selected</if>
                    >{$vo}</option>
                </foreach>
            </select>
            <else/>
            <select class="form-control post-params" lay-search lay-filter="type" name="type">
                <foreach item="vo" key="key" name="type_list">
                    <option value="{$key}">{$vo}</option>
                </foreach>
            </select>
        </if>
    </div>
</div>


<!--备注-->
<div class="form-group">
    <label class="col-sm-2 control-label">备注:</label>
    <div class="layui-input-block col-sm-6">
        <input type="text" name="name" class="form-control post-params item-left" value="{$name|default=''}">
    </div>
</div>


<!--自定义表单 两个input,横向排序-->
<style>
    .layui-btn .layui-icon {
        vertical-align: middle !important;
    }


    /* 优化输入框和开关的容器样式 */
    #data_value00001 {
        padding: 10px 0;
    }

    #data_value00001 > div {
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .layui-inline {
        vertical-align: middle;
    }


    .form-control.post-params:focus {
        border-color: #1E9FFF;
        box-shadow: 0 0 0 2px rgba(30, 159, 255, 0.2);
        outline: none;
    }

    /* 优化开关样式和对齐 */
    .switch-container {
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .switch-text {
        color: #666;
        font-size: 14px;
    }

    /* 优化按钮样式 */
    .layui-btn-sm {
        padding: 0 15px;
        height: 38px;
        line-height: 38px;
    }

    .removeclass {
        transition: all 0.2s;
    }

    .removeclass:hover {
        background-color: #f53f3f !important;
    }

    #button_data_value00001 {
        transition: all 0.2s;
    }

    #button_data_value00001:hover {
        background-color: #ff9900 !important;
    }
</style>

<div class="form-group">
    <div class="layui-form-item">
        <label class="col-sm-2 control-label">基础信息:</label>
        <div class="col-md-6 col-sm-10" id="data_value00001" style="">
            <!-- 已有数据的字段 -->
            <if condition="!empty($value)">
                <foreach item="data_val" key="data_index" name="value">
                    <div class="item-container">
                        <!-- 字段名称输入框 -->
                        <div class="layui-inline">
                            <input class="form-control post-params" name="data_key[{$data_index}]"
                                   placeholder="名称" type="text" value="{$data_val.name}">
                        </div>
                        <!-- 类型选择器：明确“问答”对应 value="text"，多选/单选对应 radio/checkbox -->
                        <div class="layui-inline switch-container">
                            <span class="switch-text">类型:</span>
                            <select name="data_type[{$data_index}]" class="form-control post-params type-select"
                                    data-index="{$data_index}" lay-filter="typeSelect">
                                <option value="text" <if condition="$data_val.type eq 'text'">selected</if>>问答</option>
                                <option value="radio" <if condition="$data_val.type eq 'radio'">selected</if>>单选</option>
                                <option value="checkbox" <if condition="$data_val.type eq 'checkbox'">selected</if>>多选</option>
                            </select>
                        </div>
                        <!-- 删除按钮 -->
                        <div class="layui-inline">
                            <button class="layui-btn layui-btn-danger layui-btn-sm removeclass" type="button">
                                <i class="layui-icon">&#xe67e;</i>
                            </button>
                        </div>

                        <!-- 字段补充说明文本域（始终显示） -->
                        <textarea class="form-control post-params" name="field_remark[{$data_index}]" rows="2"
                                  placeholder="字段补充说明（必填/选填等）" style="margin-top: 8px; width: 100%;">{$data_val.field_remark|default=''}</textarea>

                        <!-- 选项列表（默认隐藏，多选/单选时显示） -->
                        <div class="options-list options-list-{$data_index}"
                             style="display: none; margin-top: 10px;">
                            <if condition="!empty($data_val.options)">
                                <foreach item="option" key="opt_index" name="data_val.options">
                                    <div class="option-item" style="margin-top: 5px;">
                                        <input type="text" class="form-control" name="options[{$data_index}][]"
                                               value="{$option}" placeholder="选项内容">
                                        <button type="button" class="layui-btn layui-btn-danger layui-btn-sm remove-option" style="margin-left: 5px;">
                                            <i class="layui-icon">&#xe67e;</i>
                                        </button>
                                    </div>
                                </foreach>
                            </if>
                            <button type="button" class="layui-btn layui-btn-normal layui-btn-sm add-option"
                                    style="margin-top: 5px;" data-index="{$data_index}">
                                <i class="layui-icon">&#xe654;</i> 添加选项
                            </button>
                        </div>

                        <!-- 目标文本域：默认隐藏，仅多选/单选时显示 -->
                        <textarea class="form-control post-params radio-checkbox-remark remark-{$data_index}"
                                  name="remark[{$data_index}]" rows="2" placeholder="补充说明（可选）"
                                  style="display: none; margin-top: 10px;">{$data_val.remark|default=''}</textarea>
                    </div>
                </foreach>
            </if>

            <!-- 新增空白字段（初始索引：99999999999999） -->
            <div class="item-container">
                <div class="layui-inline">
                    <input class="form-control post-params" name="data_key[99999999999999]"
                           placeholder="名称" type="text">
                </div>
                <div class="layui-inline switch-container">
                    <span class="switch-text">类型:</span>
                    <select name="data_type[99999999999999]" class="form-control post-params type-select"
                            data-index="99999999999999" lay-filter="typeSelect">
                        <option value="text">问答</option>
                        <option value="radio">单选</option>
                        <option value="checkbox">多选</option>
                    </select>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn layui-btn-warm layui-btn-sm" id="button_data_value00001" type="button">
                        <i class="layui-icon">&#xe654; </i>
                    </button>
                </div>

                <!-- 字段补充说明文本域（始终显示） -->
                <textarea class="form-control post-params" name="field_remark[99999999999999]" rows="2"
                          placeholder="字段补充说明（必填/选填等）" style="margin-top: 8px; width: 100%;"></textarea>

                <!-- 选项列表（默认隐藏） -->
                <div class="options-list options-list-99999999999999" style="display: none; margin-top: 10px;">
                    <div class="options-list-inner"></div>
                    <button type="button" class="layui-btn layui-btn-normal layui-btn-sm add-option"
                            style="margin-top: 5px;" data-index="99999999999999">
                        <i class="layui-icon">&#xe654;</i> 添加选项
                    </button>
                </div>

                <!-- 目标文本域（默认隐藏） -->
                <textarea class="form-control post-params radio-checkbox-remark remark-99999999999999"
                          name="remark[99999999999999]" rows="2" placeholder="补充说明（可选）"
                          style="display: none; margin-top: 10px;"></textarea>
            </div>
        </div>
    </div>
</div>

<script>
    layui.use(['element', 'jquery', 'layer', 'form', 'laydate'], function () {
        var form = layui.form
            , element = layui.element
            , laydate = layui.laydate
            , $ = layui.$;

        // 初始化函数：设置选项列表和文本域的显示状态
        function setRemarkAndOptionsShow(index, type) {
            // 获取当前索引对应的元素
            var $optionsList = $('.options-list-' + index);
            var $remarkTextarea = $('.remark-' + index);

            // 验证元素是否存在
            if (!$optionsList.length || !$remarkTextarea.length) {
                console.warn('未找到索引为 ' + index + ' 的元素');
                return;
            }

            // 根据类型设置显示状态
            if (type === 'radio' || type === 'checkbox') {
                $optionsList.show();
                $remarkTextarea.show();

                // 空选项列表自动添加一个选项
                if ($optionsList.find('.option-item').length === 0) {
                    $optionsList.find('.add-option').trigger('click');
                }
            } else {
                $optionsList.hide();
                $remarkTextarea.hide();
            }
        }

        // 页面加载时初始化所有字段的显示状态
        $(document).ready(function() {
            $('.type-select').each(function() {
                var $this = $(this);
                var type = $this.val();
                var index = $this.attr('data-index');
                setRemarkAndOptionsShow(index, type);
            });
        });

        // 使用layui的form事件监听选择器变化，更可靠
        form.on('select(typeSelect)', function(data) {
            var $select = $(data.elem);
            var index = $select.attr('data-index');
            var selectedType = data.value;
            setRemarkAndOptionsShow(index, selectedType);
        });

        // 删除整个字段
        $("body").on('click', ".removeclass", function () {
            if (confirm('确定要删除这个字段吗？')) {
                $(this).closest('.item-container').remove();
            }
        });

        // 添加选项
        $("body").on('click', '.add-option', function () {
            var $this = $(this);
            var index = $this.attr('data-index');
            var $optionsList = $this.closest('.options-list');
            var $optionsListInner = $optionsList.find('.options-list-inner');

            // 如果没有inner容器，直接添加到列表中
            if (!$optionsListInner.length) {
                $optionsListInner = $optionsList;
            }

            var optionHtml = '<div class="option-item" style="margin-top: 5px;">' +
                '<input type="text" class="form-control" name="options[' + index + '][]" placeholder="选项内容">' +
                '<button type="button" class="layui-btn layui-btn-danger layui-btn-sm remove-option" style="margin-left: 5px;">' +
                '<i class="layui-icon">&#xe67e;</i>' +
                '</button>' +
                '</div>';

            $optionsListInner.append(optionHtml);
        });

        // 删除单个选项
        $("body").on('click', '.remove-option', function () {
            var $optionItem = $(this).closest('.option-item');
            // 确保至少保留一个选项
            if ($optionItem.siblings('.option-item').length > 0 || confirm('确定要删除最后一个选项吗？')) {
                $optionItem.remove();
            }
        });

        // 新增字段
        $("#button_data_value00001").click(function () {
            var newIndex = Date.now() + Math.floor(Math.random() * 1000);
            var newFieldHtml = '<div class="item-container">' +
                '<div class="layui-inline">' +
                '<input type="text" name="data_key[' + newIndex + ']" class="form-control post-params" placeholder="名称">' +
                '</div>' +
                '<div class="layui-inline switch-container">' +
                '<span class="switch-text">类型:</span>' +
                '<select name="data_type[' + newIndex + ']" class="form-control post-params type-select" data-index="' + newIndex + '" lay-filter="typeSelect">' +
                '<option value="text">问答</option>' +
                '<option value="radio">单选</option>' +
                '<option value="checkbox">多选</option>' +
                '</select>' +
                '</div>' +
                '<div class="layui-inline">' +
                '<button type="button" class="layui-btn layui-btn-danger layui-btn-sm removeclass" style="margin-left: 5px;"> <i class="layui-icon">&#xe67e;</i> </button>' +
                '</div>' +
                '<textarea class="form-control post-params" name="field_remark[' + newIndex + ']" rows="2" ' +
                'placeholder="字段补充说明（必填/选填等）" style="margin-top: 8px; width: 100%;"></textarea>' +
                '<div class="options-list options-list-' + newIndex + '" style="display: none; margin-top: 10px;">' +
                '<div class="options-list-inner"></div>' +
                '<button type="button" class="layui-btn layui-btn-normal layui-btn-sm add-option" style="margin-top: 5px;" data-index="' + newIndex + '">' +
                '<i class="layui-icon">&#xe654;</i> 添加选项' +
                '</button>' +
                '</div>' +
                '<textarea class="form-control post-params radio-checkbox-remark remark-' + newIndex + '" name="remark[' + newIndex + ']" rows="2" ' +
                'placeholder="补充说明（可选）" style="display: none; margin-top: 10px;"></textarea>' +
                '</div>';

            $("#data_value00001").append(newFieldHtml);
            form.render('select'); // 重新渲染select，确保layui样式生效
        });
    });
</script>







